<h2 align='center'>Ditto: Motion-Space Diffusion for Controllable Realtime Talking Head Synthesis</h2>

<div align='center'>
    <a href=""><strong>Tianqi Li</strong></a>
    Â·
    <a href=""><strong>Ruobing Zheng</strong></a><sup>â€ </sup>
    Â·
    <a href=""><strong>Minghui Yang</strong></a>
    Â·
    <a href=""><strong>Jingdong Chen</strong></a>
    Â·
    <a href=""><strong>Ming Yang</strong></a>
</div>
<div align='center'>
Ant Group
</div>
<br>
<div align='center'>
    <a href='https://arxiv.org/abs/2411.19509'><img src='https://img.shields.io/badge/Paper-arXiv-red'></a>
    <a href='https://digital-avatar.github.io/ai/Ditto/'><img src='https://img.shields.io/badge/Project-Page-blue'></a>
    <a href='https://huggingface.co/digital-avatar/ditto-talkinghead'><img src='https://img.shields.io/badge/Model-HuggingFace-yellow'></a>
    <a href='https://github.com/antgroup/ditto-talkinghead'><img src='https://img.shields.io/badge/Code-GitHub-purple'></a>
    <!-- <a href='https://github.com/antgroup/ditto-talkinghead'><img src='https://img.shields.io/github/stars/antgroup/ditto-talkinghead?style=social'></a> -->
</div>
<br>
<div align="center">
    <video style="width: 95%; object-fit: cover;" controls loop src="https://digital-avatar.github.io/ai/Ditto/asserts/videos/full_body_en.mp4" muted="false"></video>
    <p>
    âœ¨  For more results, visit our <a href="https://digital-avatar.github.io/ai/Ditto/"><strong>Project Page</strong></a> âœ¨ 
    </p>
</div>


## ğŸ“Œ Updates

* [2025.01.10] ğŸ”¥ We release our inference [codes](https://github.com/antgroup/ditto-talkinghead) and [models](https://huggingface.co/digital-avatar/ditto-talkinghead).
* [2024.11.29] ğŸ”¥ Our [paper](https://arxiv.org/abs/2411.19509) is in public on arxiv.

 

## ğŸ› ï¸ Installation

Tested Environment  
- System: Centos 7.2  
- GPU: A100  
- Python: 3.10  
- tensorRT: 8.6.1  


Clone the codes from [GitHub](https://github.com/antgroup/ditto-talkinghead):  
```bash
git clone https://github.com/antgroup/ditto-talkinghead
cd ditto-talkinghead
```


Create `conda` environment:
```bash
conda env create -f environment.yaml
conda activate ditto
```

## ğŸ“¥ Download Checkpoints

Download checkpoints from [HuggingFace](https://huggingface.co/digital-avatar/ditto-talkinghead) and put them in `checkpoints` dir:
```bash
git lfs install
git clone https://huggingface.co/digital-avatar/ditto-talkinghead checkpoints
```

The `checkpoints` should be like:
```text
./checkpoints/
â”œâ”€â”€ ditto_cfg
â”‚Â Â  â”œâ”€â”€ v0.4_hubert_cfg_trt.pkl
â”‚Â Â  â””â”€â”€ v0.4_hubert_cfg_trt_online.pkl
â”œâ”€â”€ ditto_onnx
â”‚Â Â  â”œâ”€â”€ appearance_extractor.onnx
â”‚Â Â  â”œâ”€â”€ blaze_face.onnx
â”‚Â Â  â”œâ”€â”€ decoder.onnx
â”‚Â Â  â”œâ”€â”€ face_mesh.onnx
â”‚Â Â  â”œâ”€â”€ hubert.onnx
â”‚Â Â  â”œâ”€â”€ insightface_det.onnx
â”‚Â Â  â”œâ”€â”€ landmark106.onnx
â”‚Â Â  â”œâ”€â”€ landmark203.onnx
â”‚Â Â  â”œâ”€â”€ libgrid_sample_3d_plugin.so
â”‚Â Â  â”œâ”€â”€ lmdm_v0.4_hubert.onnx
â”‚Â Â  â”œâ”€â”€ motion_extractor.onnx
â”‚Â Â  â”œâ”€â”€ stitch_network.onnx
â”‚Â Â  â””â”€â”€ warp_network.onnx
â””â”€â”€ ditto_trt_Ampere_Plus
    â”œâ”€â”€ appearance_extractor_fp16.engine
    â”œâ”€â”€ blaze_face_fp16.engine
    â”œâ”€â”€ decoder_fp16.engine
    â”œâ”€â”€ face_mesh_fp16.engine
    â”œâ”€â”€ hubert_fp32.engine
    â”œâ”€â”€ insightface_det_fp16.engine
    â”œâ”€â”€ landmark106_fp16.engine
    â”œâ”€â”€ landmark203_fp16.engine
    â”œâ”€â”€ lmdm_v0.4_hubert_fp32.engine
    â”œâ”€â”€ motion_extractor_fp32.engine
    â”œâ”€â”€ stitch_network_fp16.engine
    â””â”€â”€ warp_network_fp16.engine
```

- The `ditto_cfg/v0.4_hubert_cfg_trt_online.pkl` is online config
- The `ditto_cfg/v0.4_hubert_cfg_trt.pkl` is offline config


## ğŸš€ Inference 

Run `inference.py`:

```shell
python inference.py \
    --data_root "<path-to-trt-model>" \
    --cfg_pkl "<path-to-cfg-pkl>" \
    --audio_path "<path-to-input-audio>" \
    --source_path "<path-to-input-image>" \
    --output_path "<path-to-output-mp4>" 
```

For example:

```shell
python inference.py \
    --data_root "./checkpoints/ditto_trt_Ampere_Plus" \
    --cfg_pkl "./checkpoints/ditto_cfg/v0.4_hubert_cfg_trt.pkl" \
    --audio_path "./example/audio.wav" \
    --source_path "./example/image.png" \
    --output_path "./tmp/result.mp4" 
```

â—Note:

We have provided the tensorRT model with `hardware-compatibility-level=Ampere_Plus` (`checkpoints/ditto_trt_Ampere_Plus/`). If your GPU does not support it, please execute the `cvt_onnx_to_trt.py` script to convert from the general onnx model (`checkpoints/ditto_onnx/`) to the tensorRT model.

```bash
python script/cvt_onnx_to_trt.py --onnx_dir "./checkpoints/ditto_onnx" --trt_dir "./checkpoints/ditto_trt_custom"
```

Then run `inference.py` with `--data_root=./checkpoints/ditto_trt_custom`.


## ğŸ“§ Acknowledgement
Our implementation is based on [S2G-MDDiffusion](https://github.com/thuhcsi/S2G-MDDiffusion) and [LivePortrait](https://github.com/KwaiVGI/LivePortrait). Thanks for their remarkable contribution and released code! If we missed any open-source projects or related articles, we would like to complement the acknowledgement of this specific work immediately.

## âš–ï¸ License
This repository is released under the Apache-2.0 license as found in the [LICENSE](LICENSE) file.

## ğŸ“š Citation
If you find this codebase useful for your research, please use the following entry.
```BibTeX
@article{li2024ditto,
    title={Ditto: Motion-Space Diffusion for Controllable Realtime Talking Head Synthesis},
    author={Li, Tianqi and Zheng, Ruobing and Yang, Minghui and Chen, Jingdong and Yang, Ming},
    journal={arXiv preprint arXiv:2411.19509},
    year={2024}
}
```
